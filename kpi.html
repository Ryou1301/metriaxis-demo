<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Metriaxis Demo — KPI</title>
  <link rel="stylesheet" href="assets/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/config.js"></script>
  <script src="assets/supabaseClient.js"></script>
  <script src="assets/app.js"></script>
  <script src="assets/api.js"></script>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <span class="logo" aria-hidden="true"></span>
        <div>
          <div class="title">Metriaxis</div>
          <div class="subtle">Demo Netlify</div>
        </div>
      </div>

      <div class="nav" aria-label="Navigation">
        <a href="kpi.html" data-page="kpi"><span>KPI</span><span class="small">→</span></a>
        <a href="planning.html" data-page="planning"><span>Planning</span><span class="small">→</span></a>
        <a href="equipment.html" data-page="equipment"><span>Équipements</span><span class="small">→</span></a>
      </div>

      <div class="meta">
        <div class="row between">
          <div class="small">Client</div>
          <select id="clientSelect" class="input" style="max-width:160px;padding:8px 10px;border-radius:12px"></select>
        </div>
        <div style="margin-top:10px" class="kv"><span>Nom</span><span id="clientMetaName">—</span></div>
        <div class="kv"><span>Code</span><span id="clientMetaCode">—</span></div>
        <div class="kv"><span>User</span><span id="userEmail">—</span></div>
        <div style="margin-top:10px" class="row end">
          <button id="logoutBtn" class="btn secondary sm">Déconnexion</button>
        </div>
        <div id="shellNotice" class="notice" style="margin-top:10px"></div>
      </div>
    </aside>

    <main class="main">
      <div class="page-head">
        <div class="left">
          <div class="breadcrumb"><a href="kpi.html">Dashboard</a></div>
          <div class="h1">KPI</div>
          <div class="subtle">Vue rapide et tendances simples</div>
        </div>
        <div class="actions"><a class="btn secondary sm" href="planning.html">Planning</a></div>
      </div>

      
<div class="grid grid-4">
  <div class="card kpi"><div class="label">Équipements actifs</div><div class="value" id="kpiEquip">—</div><div class="hint" id="kpiEquipSub">—</div></div>
  <div class="card kpi"><div class="label">Tests en retard</div><div class="value" id="kpiOverdue">—</div><div class="hint">next_due_date &lt; aujourd’hui</div></div>
  <div class="card kpi"><div class="label">Statuts critiques</div><div class="value" id="kpiCritical">—</div><div class="hint">severity ≥ 3</div></div>
  <div class="card kpi"><div class="label">Opérations (30j)</div><div class="value" id="kpiOps30">—</div><div class="hint">performed_at</div></div>
</div>

<div class="grid grid-2" style="margin-top:12px">
  <div class="card" style="padding:14px">
    <div class="row between">
      <div><div class="h2">Répartition statuts</div><div class="subtle">Calcul sur équipement actif</div></div>
      <a class="btn secondary sm" href="equipment.html">Voir liste</a>
    </div>
    <div class="hr"></div>
    <div id="statusBreakdown" class="grid" style="gap:10px"></div>
  </div>

  <div class="card" style="padding:14px">
    <div class="row between">
      <div><div class="h2">Opérations par mois</div><div class="subtle">Année en cours</div></div>
      <a class="btn secondary sm" href="planning.html">Aller au planning</a>
    </div>
    <div class="hr"></div>
    <div class="table-wrap">
      <table class="table" id="opsByMonth">
        <thead><tr><th>Mois</th><th>Nb</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>


      <div class="modal-backdrop" id="modalBackdrop">
        <div class="modal">
          <div class="head">
            <div>
              <div class="h2" id="modalTitle">—</div>
              <div class="small" id="modalSubtitle">—</div>
            </div>
            <div class="x" id="modalClose">✕</div>
          </div>
          <div class="hr"></div>
          <div id="modalBody"></div>
        </div>
      </div>

      <script>
        (async ()=>{
          await requireAuth();
          await initShell("kpi");
          
try{
  const clientId = getClientId();
  if(!clientId){ toast("Client", "Aucun client sélectionné", "err"); return; }

  const statusMap = await fetchStatusMap();
  const equip = await sb.from('equipment').select('id,is_archived,current_status_id,created_at').eq('client_id', clientId);
  if(equip.error) throw equip.error;
  const all = equip.data || [];
  const active = all.filter(e=>!e.is_archived);

  qs('#kpiEquip').textContent = String(active.length);
  qs('#kpiEquipSub').textContent = `Total: ${all.length} (incluant archivés)`;

  const today = new Date(); today.setHours(0,0,0,0);
  const testsRes = await sb.from('equipment_tests').select('id,next_due_date,is_active').eq('client_id', clientId).eq('is_active', true);
  if(testsRes.error) throw testsRes.error;
  const overdue = (testsRes.data||[]).filter(t=> t.next_due_date && new Date(t.next_due_date) < today);
  qs('#kpiOverdue').textContent = String(overdue.length);

  const critical = active.filter(e=>{
    const s = statusMap[e.current_status_id];
    return s && Number(s.severity) >= 3;
  });
  qs('#kpiCritical').textContent = String(critical.length);

  const since = new Date(Date.now() - 30*24*3600*1000).toISOString();
  const ops30 = await sb.from('operations').select('id').eq('client_id', clientId).gte('performed_at', since);
  if(ops30.error) throw ops30.error;
  qs('#kpiOps30').textContent = String((ops30.data||[]).length);

  const buckets = { ok:0, watch:0, alert:0, crit:0, na:0 };
  for(const e of active){
    const s = statusMap[e.current_status_id];
    if(!s){ buckets.na++; continue; }
    const sev = Number(s.severity);
    if(sev >= 3) buckets.crit++;
    else if(sev === 2) buckets.alert++;
    else if(sev === 1) buckets.watch++;
    else buckets.ok++;
  }
  qs('#statusBreakdown').innerHTML = `
    <div class="row between"><span class="badge green dot">OK</span><div style="font-weight:840">${buckets.ok}</div></div>
    <div class="row between"><span class="badge orange dot">Surveillance</span><div style="font-weight:840">${buckets.watch}</div></div>
    <div class="row between"><span class="badge orange dot">Alerte</span><div style="font-weight:840">${buckets.alert}</div></div>
    <div class="row between"><span class="badge red dot">Critique</span><div style="font-weight:840">${buckets.crit}</div></div>
    <div class="row between"><span class="badge gray dot">N/A</span><div style="font-weight:840">${buckets.na}</div></div>
  `;

  const year = new Date().getFullYear();
  const start = new Date(year,0,1).toISOString();
  const end = new Date(year+1,0,1).toISOString();
  const ops = await sb.from('operations').select('performed_at').eq('client_id', clientId).gte('performed_at', start).lt('performed_at', end);
  if(ops.error) throw ops.error;
  const byMonth = Array(12).fill(0);
  (ops.data||[]).forEach(o=>{ if(o.performed_at) byMonth[new Date(o.performed_at).getMonth()]++; });
  const months = ['Jan','Fév','Mar','Avr','Mai','Juin','Juil','Aoû','Sep','Oct','Nov','Déc'];
  qs('#opsByMonth tbody').innerHTML = months.map((m,i)=>`<tr><td>${m} ${year}</td><td style="font-weight:800">${byMonth[i]}</td></tr>`).join('');
}catch(e){
  toast("Erreur", e.message || String(e), "err", 5200);
}

        })();
      </script>
    </main>
  </div>

  <script>
    (function(){
      const bd = document.getElementById('modalBackdrop');
      const close = document.getElementById('modalClose');
      function hide(){ bd.classList.remove('show'); }
      function show(){ bd.classList.add('show'); }
      bd.addEventListener('click', (e)=>{ if(e.target===bd) hide(); });
      close.addEventListener('click', hide);
      window.MXModal = {
        open: ({title, subtitle, bodyHtml})=>{
          document.getElementById('modalTitle').textContent = title || '';
          document.getElementById('modalSubtitle').textContent = subtitle || '';
          document.getElementById('modalBody').innerHTML = bodyHtml || '';
          show();
        },
        close: hide
      };
    })();
  </script>
</body>
</html>

