<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Metriaxis Demo — Login</title>
  <link rel="stylesheet" href="assets/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/config.js"></script>
  <script src="assets/supabaseClient.js"></script>
  <script src="assets/app.js"></script>
</head>
<body>
  <div class="container" style="max-width:980px;margin:0 auto;padding:20px">
    <div class="grid grid-2" style="gap:18px;align-items:stretch;margin-top:28px">
      <div class="card" style="padding:16px">
        <div class="row">
          <span class="logo" aria-hidden="true"></span>
          <div>
            <div class="h1">Metriaxis — Demo</div>
            <div class="subtle">Connexion Supabase (email / password)</div>
          </div>
        </div>
        <div class="hr"></div>

        <div id="notice" class="notice"></div>

        <div class="grid grid-2">
          <div>
            <div class="h3">Email</div>
            <input class="input" id="email" type="email" placeholder="rgaley@outlook.fr" autocomplete="email" />
          </div>
          <div>
            <div class="h3">Mot de passe</div>
            <input class="input" id="password" type="password" placeholder="••••••" autocomplete="current-password" />
          </div>
        </div>

        <div class="row end" style="margin-top:12px">
          <button id="loginBtn" class="btn primary">Se connecter</button>
        </div>

        <div class="small" style="margin-top:12px">
          Si tu n’as pas accès aux données après connexion, vérifie le lien dans <code>client_users</code>.
        </div>
      </div>

      <div class="card" style="padding:16px">
        <div class="h2">Ce que cette démo couvre</div>
        <div class="subtle">Lecture + écriture sur les tables principales</div>
        <div class="hr"></div>
        <div class="grid" style="gap:10px">
          <div class="row"><span class="badge dot green">Lecture</span><div class="small">KPI, liste, fiche équipement, planning, audit</div></div>
          <div class="row"><span class="badge dot orange">Écriture</span><div class="small">Créer opérations, créer tests, modifier équipement + détails</div></div>
          <div class="row"><span class="badge dot gray">Multi-tenant</span><div class="small">Sélecteur de client (localStorage)</div></div>
        </div>
        <div class="hr"></div>
        <div class="small">Conseil: commence par <code>kpi.html</code> après login.</div>
      </div>
    </div>
  </div>

  <script>
    (async ()=>{
      const { data } = await sb.auth.getSession();
      if(data.session) location.href = "kpi.html";
    })();

    const notice = qs('#notice');
    qs('#loginBtn').addEventListener('click', async ()=>{
      setNotice(notice, "", null);
      const email = qs('#email').value.trim();
      const password = qs('#password').value;
      if(!email || !password){ setNotice(notice, "Email et mot de passe requis.", "err"); return; }

      const { error } = await sb.auth.signInWithPassword({ email, password });
      if(error){ setNotice(notice, error.message, "err"); return; }

      const { data: clients } = await sb.from('clients').select('id').order('created_at', {ascending:true});
      if(clients?.length) localStorage.setItem('metriaxis_client_id', clients[0].id);

      toast("Connecté", "Redirection vers le tableau de bord", "ok");
      setTimeout(()=> location.href = "kpi.html", 250);
    });
  </script>
</body>
</html>
