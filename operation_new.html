<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Metriaxis Demo — Nouvelle opération</title>
  <link rel="stylesheet" href="assets/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/config.js"></script>
  <script src="assets/supabaseClient.js"></script>
  <script src="assets/app.js"></script>
  <script src="assets/api.js"></script>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <span class="logo" aria-hidden="true"></span>
        <div>
          <div class="title">Metriaxis</div>
          <div class="subtle">Demo Netlify</div>
        </div>
      </div>

      <div class="nav" aria-label="Navigation">
        <a href="kpi.html" data-page="kpi"><span>KPI</span><span class="small">→</span></a>
        <a href="equipment.html" data-page="equipment"><span>Équipements</span><span class="small">→</span></a>
      </div>

      <div class="meta">
        <div class="row between">
          <div class="small">Client</div>
          <select id="clientSelect" class="input" style="max-width:160px;padding:8px 10px;border-radius:12px"></select>
        </div>
        <div style="margin-top:10px" class="kv"><span>Nom</span><span id="clientMetaName">—</span></div>
        <div class="kv"><span>Code</span><span id="clientMetaCode">—</span></div>
        <div class="kv"><span>User</span><span id="userEmail">—</span></div>
        <div style="margin-top:10px" class="row end">
          <button id="logoutBtn" class="btn secondary sm">Déconnexion</button>
        </div>
        <div id="shellNotice" class="notice" style="margin-top:10px"></div>
      </div>
    </aside>

    <main class="main">
      <div class="page-head">
        <div class="left">
          <div class="breadcrumb"><a href="kpi.html">Dashboard</a>  /  <a href="equipment.html">Équipements</a>  /  <span class="small">Nouvelle opération</span></div>
          <div class="h1">Nouvelle opération</div>
          <div class="subtle">Saisie rapide et claire</div>
        </div>
        <div class="actions"></div>
      </div>

      
<div class="card" style="padding:14px;max-width:920px">
  <div class="row between">
    <div>
      <div class="h2">Créer une opération</div>
      <div class="subtle">Table <code>operations</code></div>
    </div>
    <a class="btn ghost sm" id="backLink" href="#">← Retour fiche</a>
  </div>

  <div class="hr"></div>

  <div class="grid grid-2">
    <div>
      <div class="h3">Équipement</div>
      <input class="input" id="equipment_id" readonly>
    </div>
    <div>
      <div class="h3">Type d’opération</div>
      <select class="input" id="operation_type_id"></select>
    </div>

    <div>
      <div class="h3">Date réalisée</div>
      <input class="input" id="performed_at" type="datetime-local">
    </div>
    <div>
      <div class="h3">Intervenant</div>
      <input class="input" id="intervenant_text" placeholder="Interne / Externe">
    </div>

    <div>
      <div class="h3">Conformité</div>
      <select class="input" id="conformity">
        <option value="">—</option>
        <option value="true">Conforme</option>
        <option value="false">Non conforme</option>
      </select>
    </div>
    <div>
      <div class="h3">Nouveau statut</div>
      <select class="input" id="resulting_status_id"></select>
    </div>
  </div>

  <div style="margin-top:10px">
    <div class="h3">Commentaire</div>
    <textarea class="input" id="comment"></textarea>
  </div>

  <div class="row end" style="margin-top:12px">
    <div class="hr"></div>
<div class="grid grid-2" style="margin-top:10px">
  <div>
    <div class="h3">Document (upload)</div>
    <input id="docFile" class="input" type="file" />
    <div class="small">Le fichier sera stocké dans Supabase Storage puis lié à l’opération.</div>
  </div>
  <div>
    <div class="h3">Type document</div>
    <input id="docType" class="input" placeholder="rapport, certificat, photo…">
    <div style="margin-top:10px">
      <div class="h3">Tags (csv)</div>
      <input id="docTags" class="input" placeholder="maintenance,intervention,SAV">
    </div>
  </div>
</div>

<button id="createBtn" class="btn primary">Créer</button>
  </div>
</div>


      <script>
        (async ()=>{
          await requireAuth();
          await initShell("equipment");
          
const equipment_id = getParam('equipment_id');
if(!equipment_id){ toast("Navigation", "equipment_id manquant", "err"); throw new Error("missing equipment_id"); }
qs('#equipment_id').value = equipment_id;
qs('#backLink').href = `equipment_view.html?id=${encodeURIComponent(equipment_id)}#operations`;

const statusMap = await fetchStatusMap();
qs('#resulting_status_id').innerHTML = `<option value="">—</option>` + Object.values(statusMap).map(s=>`<option value="${s.id}">${s.label} (sev ${s.severity})</option>`).join('');

const opTypesAll = await lookup('operation_types','id,code,label,category,is_active');
// "Créer une opération" doit proposer:
// - opérations de base (category=classic)
// - tests réellement paramétrés (category=test ET au moins 1 template actif)
const templatesAll = await lookup('test_templates','id,name,operation_type_id,is_active');
const allowedTestOpTypeIds = new Set((templatesAll||[])
  .filter(t=>t.is_active!==false && t.operation_type_id)
  .map(t=>t.operation_type_id));
const opTypes = (opTypesAll||[]).filter(o=>{
  if(o.is_active===false) return false;
  if(o.category==='classic') return true;
  if(o.category==='test') return allowedTestOpTypeIds.has(o.id);
  return false;
});
qs('#operation_type_id').innerHTML = `<option value="">—</option>` + opTypes.filter(o=>o.is_active!==false).map(o=>`<option value="${o.id}">${o.label}</option>`).join('');

const now = new Date();
qs('#performed_at').value = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().slice(0,16);

qs('#createBtn').addEventListener('click', async ()=>{
  const btn = qs('#createBtn');
  btn.disabled = true;
  try{
    const payload = {
      client_id: getClientId(),
      equipment_id,
      operation_type_id: qs('#operation_type_id').value || null,
      performed_at: qs('#performed_at').value ? new Date(qs('#performed_at').value).toISOString() : null,
      intervenant_text: qs('#intervenant_text').value.trim() || null,
      conformity: qs('#conformity').value === '' ? null : (qs('#conformity').value === 'true'),
      resulting_status_id: qs('#resulting_status_id').value || null,
      comment: qs('#comment').value.trim() || null
    };
    const { error } = await sb.from('operations').insert(payload);
    if(error) throw error;

    toast("Créé", "Opération enregistrée", "ok");
    setTimeout(()=> location.href = `equipment_view.html?id=${encodeURIComponent(equipment_id)}#operations`, 250);
  }catch(e){
    toast("Erreur", e.message || String(e), "err", 5200);
  }finally{
    btn.disabled = false;
  }
});

        })();
      </script>
    </main>
  </div>
</body>
</html>

